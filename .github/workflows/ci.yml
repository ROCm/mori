name: mori
on: push
jobs:
  build:
    name: mori build
    runs-on: label-1
    steps:
      - name: clone source code
        run: |
          pwd
          hostname
          id
          cmake --version
          #exit 
          #source ~/.bashrc
          echo "0. PATH: $PATH"
          export PATH="/home/runner/.local/bin:$PATH"
          cmake --version
          echo "=== CMake 版本诊断 ==="
          echo "1. PATH: $PATH"
          echo "2. which cmake: $(which cmake)"
          echo "3. 所有 cmake 路径:"
          which -a cmake
          echo "4. 各路径版本:"
          for cmd in $(which -a cmake); do
            echo "   $cmd: $($cmd --version | head -n1)"
          done
          echo "5. 当前 shell: $SHELL"
          #sudo -i
          pwd
          id  
          ls  
          #rm -rf mori

          #git clone https://github.com/zhangfei829/mytest.git
          #git clone https://github.com/ROCm/mori.git
          cd mori
          git checkout ionic_new_950_1128
          pip install -r requirements-build.txt
          git submodule update --init --recursive
          USE_IONIC=ON pip3 install . --no-build-isolation --target /apps/mori-ci/python-packages
          #make
          ls
  test:
    name: mori test
    needs: build
    runs-on: label-1
    steps:
        #- uses: actions/checkout@v4
        #- name: Set up Python
        #uses: actions/setup-python@v4
        #with:
                #python-version: '3.11'
      #- run: pip install -r requirements.txt
      - name: Run tests
        run: |
          cd mori
          ls
          id
          getent group video
          getent group kvm  
          getent group render
          newgrp ci
          id
          newgrp video
          id
          su ci -c "id"
          #groupadd ci && useradd -m -g ci -s /bin/bash ci
          newgrp video
          id
          groups
          rocm-smi
          /opt/rocm/bin/rocminfo
          #python test.py
          #bash test.sh
          #export PYTHONPATH=/home/runner/actions-runner/_work/mori/mori/mori:$PYTHONPATH
          export PYTHONPATH=/apps/mori-ci/python-packages:$PYTHONPATH
          #python3 tests/python/ops/bench_dispatch_combine.py
          #pytest -v tests/python/ops/
          mpiexec --allow-run-as-root -x MORI_GLOBAL_LOG_LEVEL=TRACE -np 2 ./build/examples/dist_write -c 1 -t 1 -q 1
